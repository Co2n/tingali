<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <script>
            (function() {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch(e) { console.log("Storage clear blocked"); }
                
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
            })();

            var timeStamp = new Date().getTime();
            function loadCSS(href) {
                document.write('<link rel="stylesheet" href="' + href + '?v=' + timeStamp + '">');
            }
            function loadJS(src) {
                document.write('<script src="' + src + '?v=' + timeStamp + '"><\/script>');
            }
        </script>

        <script>
            loadCSS('css/leaflet.css');
            loadCSS('css/L.Control.Layers.Tree.css');
            loadCSS('css/qgis2web.css');
            loadCSS('css/fontawesome-all.min.css');
            loadCSS('css/leaflet-search.css');
            loadCSS('css/leaflet.photon.css');
            loadCSS('css/leaflet-measure.css');
        </script>
        
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title></title>
    </head>
    <body>
        <div id="map">
        </div>

        <script>
            loadJS('js/qgis2web_expressions.js');
            loadJS('js/leaflet.js');
            loadJS('js/L.Control.Layers.Tree.min.js');
            loadJS('js/multi-style-layer.js');
            loadJS('js/leaflet.rotatedMarker.js');
            loadJS('js/leaflet.pattern.js');
            loadJS('js/leaflet-hash.js');
            loadJS('js/Autolinker.min.js');
            loadJS('js/rbush.min.js');
            loadJS('js/labelgun.min.js');
            loadJS('js/labels.js');
            loadJS('js/leaflet.photon.js');
            loadJS('js/leaflet-measure.js');
            loadJS('js/proj4.js');
            loadJS('js/proj4leaflet.js');
            loadJS('js/leaflet-search.js');
            loadJS('js/pinbyurl.js');
            
            // DATA LAYERS
            loadJS('data/UPDATE_19_01_2026_2107_2.js');
            loadJS('data/Floating_3.js');
            loadJS('data/Kurang_4.js');
        </script>

        <script>
        // --- PERBAIKAN DI SINI: Deklarasi variabel Global ---
        // Variabel ini harus ada di root agar labels.js bisa melihatnya
        var map; 
        var highlightLayer;
        var bounds_group;
        var hash;
        
        // Fungsi highlightFeature juga harus bisa diakses global jika diperlukan oleh event on-page
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'rgba(255, 255, 0, 1.00)',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: 'rgba(255, 255, 0, 1.00)',
                fillOpacity: 1
              });
            }
        }

        window.addEventListener('load', function() {
            
            var crs = new L.Proj.CRS('EPSG:23835', '+proj=tmerc +lat_0=0 +lon_0=109.5 +k=0.9999 +x_0=200000 +y_0=1500000 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs', {
                resolutions: [2800, 1400, 700, 350, 175, 84, 42, 21, 11.2, 5.6, 2.8, 1.4, 0.7, 0.35, 0.14, 0.07],
            });
            
            // --- PERBAIKAN: Menghapus 'var' agar menggunakan variabel global 'map' ---
            map = L.map('map', {
                crs: crs,
                continuousWorld: false,
                worldCopyJump: false, 
                zoomControl:false, maxZoom:28, minZoom:1
            }).fitBounds([[-6.983828206987602,108.6803292808397],[-6.963977518100445,108.7101632355393]]);
            
            hash = new L.Hash(map); // Menggunakan variabel global hash
            
            map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
            var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
            
            function removeEmptyRowsFromPopupContent(content, feature) {
             var tempDiv = document.createElement('div');
             tempDiv.innerHTML = content;
             var rows = tempDiv.querySelectorAll('tr');
             for (var i = 0; i < rows.length; i++) {
                 var td = rows[i].querySelector('td.visible-with-data');
                 var key = td ? td.id : '';
                 if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                     rows[i].parentNode.removeChild(rows[i]);
                 }
             }
             return tempDiv.innerHTML;
            }
            
            function addClassToPopupIfMedia(content, popup) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                var imgTd = tempDiv.querySelector('td img');
                if (imgTd) {
                    var src = imgTd.getAttribute('src');
                    if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                        popup._contentNode.classList.add('media');
                        setTimeout(function() {
                            popup.update();
                        }, 10);
                    } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                        var audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = src;
                        imgTd.parentNode.replaceChild(audio, imgTd);
                        popup._contentNode.classList.add('media');
                        setTimeout(function() {
                            popup.setContent(tempDiv.innerHTML);
                            popup.update();
                        }, 10);
                    } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                        var video = document.createElement('video');
                        video.controls = true;
                        video.src = src;
                        video.style.width = "400px";
                        video.style.height = "300px";
                        video.style.maxHeight = "60vh";
                        video.style.maxWidth = "60vw";
                        imgTd.parentNode.replaceChild(video, imgTd);
                        popup._contentNode.classList.add('media');
                        video.addEventListener('loadedmetadata', function() {
                            popup.update();
                        });
                        setTimeout(function() {
                            popup.setContent(tempDiv.innerHTML);
                            popup.update();
                        }, 10);
                    } else {
                        popup._contentNode.classList.remove('media');
                    }
                } else {
                    popup._contentNode.classList.remove('media');
                }
            }
            
            var zoomControl = L.control.zoom({
                position: 'topleft'
            }).addTo(map);
            var measureControl = new L.Control.Measure({
                position: 'topleft',
                primaryLengthUnit: 'meters',
                secondaryLengthUnit: 'kilometers',
                primaryAreaUnit: 'sqmeters',
                secondaryAreaUnit: 'hectares'
            });
            measureControl.addTo(map);
            document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
            document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
            
            // --- PERBAIKAN: Menggunakan variabel global bounds_group ---
            bounds_group = new L.featureGroup([]);
            
            function setBounds() {
            }
            
            function pop_UPDATE_19_01_2026_2107_0(feature, layer) {
                layer.on({
                    mouseout: function(e) {
                        for (var i in e.target._eventParents) {
                            if (typeof e.target._eventParents[i].resetStyle === 'function') {
                                e.target._eventParents[i].resetStyle(e.target);
                            }
                        }
                    },
                    mouseover: highlightFeature,
                });
                var popupContent = '<table>\
                        <tr>\
                            <td class="visible-with-data" id="Luas PTSL" colspan="2"><strong>Luas PTSL</strong><br />' + (feature.properties['Luas PTSL'] !== null ? autolinker.link(String(feature.properties['Luas PTSL']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td colspan="2">' + (feature.properties['key2'] !== null ? autolinker.link(String(feature.properties['key2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td class="visible-with-data" id="link" colspan="2"><strong>link</strong><br />' + (feature.properties['link'] !== null ? autolinker.link(String(feature.properties['link']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                    </table>';
                var content = removeEmptyRowsFromPopupContent(popupContent, feature);
                layer.on('popupopen', function(e) {
                    addClassToPopupIfMedia(content, e.popup);
                });
                layer.bindPopup(content, { maxHeight: 400 });
            }

            function style_UPDATE_19_01_2026_2107_0_0(feature) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                if (exp_UPDATE_19_01_2026_2107_0rule0_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(238,211,254,0.9019607843137255)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule1_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(202,236,255,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule2_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(255,207,215,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule3_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(255,228,202,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule4_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(198,255,195,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule5_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(220,224,255,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule6_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(58,58,58,1.0)', interactive: true, };
                }
                else if (exp_UPDATE_19_01_2026_2107_0rule7_eval_expression(context)) {
                      return { pane: 'pane_UPDATE_19_01_2026_2107_0', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(183,232,113,1.0)', interactive: true, };
                }
                else {
                    return {fill: false, stroke: false};
                }
            }

            map.createPane('pane_UPDATE_19_01_2026_2107_0');
            map.getPane('pane_UPDATE_19_01_2026_2107_0').style.zIndex = 400;
            map.getPane('pane_UPDATE_19_01_2026_2107_0').style['mix-blend-mode'] = 'normal';
            var layer_UPDATE_19_01_2026_2107_0 = new L.geoJson(json_UPDATE_19_01_2026_2107_2, {
                attribution: '',
                interactive: true,
                dataVar: 'json_UPDATE_19_01_2026_2107_0',
                layerName: 'layer_UPDATE_19_01_2026_2107_0',
                pane: 'pane_UPDATE_19_01_2026_2107_0',
                onEachFeature: pop_UPDATE_19_01_2026_2107_0,
                style: style_UPDATE_19_01_2026_2107_0_0,
            });
            bounds_group.addLayer(layer_UPDATE_19_01_2026_2107_0);
            map.addLayer(layer_UPDATE_19_01_2026_2107_0);

            function pop_Floating_1(feature, layer) {
                layer.on({
                    mouseout: function(e) {
                        for (var i in e.target._eventParents) {
                            if (typeof e.target._eventParents[i].resetStyle === 'function') {
                                e.target._eventParents[i].resetStyle(e.target);
                            }
                        }
                    },
                    mouseover: highlightFeature,
                });
                var popupContent = '<table>\
                        <tr>\
                            <td class="visible-with-data" id="jenis" colspan="2"><strong>jenis</strong><br />' + (feature.properties['jenis'] !== null ? autolinker.link(String(feature.properties['jenis']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td colspan="2">' + (feature.properties['validasi'] !== null ? autolinker.link(String(feature.properties['validasi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td class="visible-with-data" id="Luas PTSL" colspan="2"><strong>Luas PTSL</strong><br />' + (feature.properties['Luas PTSL'] !== null ? autolinker.link(String(feature.properties['Luas PTSL']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td colspan="2">' + (feature.properties['key2'] !== null ? autolinker.link(String(feature.properties['key2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td class="visible-with-data" id="link" colspan="2"><strong>link</strong><br />' + (feature.properties['link'] !== null ? autolinker.link(String(feature.properties['link']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                    </table>';
                var content = removeEmptyRowsFromPopupContent(popupContent, feature);
                layer.on('popupopen', function(e) {
                    addClassToPopupIfMedia(content, e.popup);
                });
                layer.bindPopup(content, { maxHeight: 400 });
            }

            function style_Floating_1_0(feature) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                if (exp_Floating_1rule0_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(205,121,255,0.9019607843137255)', interactive: true, };
                }
                else if (exp_Floating_1rule1_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(95,198,254,1.0)', interactive: true, };
                }
                else if (exp_Floating_1rule2_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(248,116,136,1.0)', interactive: true, };
                }
                else if (exp_Floating_1rule3_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(246,169,93,1.0)', interactive: true, };
                }
                else if (exp_Floating_1rule4_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(115,255,107,1.0)', interactive: true, };
                }
                else if (exp_Floating_1rule5_eval_expression(context)) {
                      return { pane: 'pane_Floating_1', opacity: 1, color: 'rgba(35,35,35,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(130,144,251,1.0)', interactive: true, };
                }
                else {
                    return {fill: false, stroke: false};
                }
            }

            map.createPane('pane_Floating_1');
            map.getPane('pane_Floating_1').style.zIndex = 401;
            map.getPane('pane_Floating_1').style['mix-blend-mode'] = 'normal';
            var layer_Floating_1 = new L.geoJson(json_Floating_3, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Floating_1',
                layerName: 'layer_Floating_1',
                pane: 'pane_Floating_1',
                onEachFeature: pop_Floating_1,
                style: style_Floating_1_0,
            });
            bounds_group.addLayer(layer_Floating_1);
            map.addLayer(layer_Floating_1);

            function pop_Kurang_2(feature, layer) {
                layer.on({
                    mouseout: function(e) {
                        for (var i in e.target._eventParents) {
                            if (typeof e.target._eventParents[i].resetStyle === 'function') {
                                e.target._eventParents[i].resetStyle(e.target);
                            }
                        }
                    },
                    mouseover: highlightFeature,
                });
                var popupContent = '<table>\
                        <tr>\
                            <td class="visible-with-data" id="validasi" colspan="2"><strong>Kekurangan</strong><br />' + (feature.properties['validasi'] !== null ? autolinker.link(String(feature.properties['validasi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td class="visible-with-data" id="Luas PTSL" colspan="2"><strong>Luas PTSL</strong><br />' + (feature.properties['Luas PTSL'] !== null ? autolinker.link(String(feature.properties['Luas PTSL']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td colspan="2">' + (feature.properties['key2'] !== null ? autolinker.link(String(feature.properties['key2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                        <tr>\
                            <td class="visible-with-data" id="link" colspan="2"><strong>link</strong><br />' + (feature.properties['link'] !== null ? autolinker.link(String(feature.properties['link']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                        </tr>\
                    </table>';
                var content = removeEmptyRowsFromPopupContent(popupContent, feature);
                layer.on('popupopen', function(e) {
                    addClassToPopupIfMedia(content, e.popup);
                });
                layer.bindPopup(content, { maxHeight: 400 });
            }

            var pattern_Kurang_2_0 = new L.StripePattern({
                weight: 0.3,
                spaceWeight: 2.0,
                color: '#000000',
                opacity: 1.0,
                spaceOpacity: 0,
                angle: 315
            });
            pattern_Kurang_2_0.addTo(map);

            function style_Kurang_2_0() {
                return {
                    pane: 'pane_Kurang_2',
                    stroke: false,
                    fillOpacity: 1,
                    fillPattern: pattern_Kurang_2_0,
                    interactive: true,
                }
            }
            function style_Kurang_2_1() {
                return {
                    pane: 'pane_Kurang_2',
                    opacity: 1,
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '',
                    lineCap: 'square',
                    lineJoin: 'bevel',
                    weight: 1,
                    fillOpacity: 0,
                    interactive: true,
                }
            }
            map.createPane('pane_Kurang_2');
            map.getPane('pane_Kurang_2').style.zIndex = 402;
            map.getPane('pane_Kurang_2').style['mix-blend-mode'] = 'normal';
            var layer_Kurang_2 = new L.geoJson.multiStyle(json_Kurang_4, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Kurang_2',
                layerName: 'layer_Kurang_2',
                pane: 'pane_Kurang_2',
                onEachFeature: pop_Kurang_2,
                styles: [style_Kurang_2_0,style_Kurang_2_1,]
            });
            bounds_group.addLayer(layer_Kurang_2);
            map.addLayer(layer_Kurang_2);
            setBounds();
            
            var i = 0;
            layer_UPDATE_19_01_2026_2107_0.eachLayer(function(layer) {
                var context = {
                    feature: layer.feature,
                    variables: {}
                };
                layer.bindTooltip((layer.feature.properties['label'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['label']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_UPDATE_19_01_2026_2107_0'});
                labels.push(layer);
                totalMarkers += 1;
                  layer.added = true;
                  addLabel(layer, i);
                  i++;
            });
            map.addControl(new L.Control.Search({
                layer: layer_UPDATE_19_01_2026_2107_0,
                initial: false,
                hideMarkerOnCollapse: true,
                propertyName: 'key2'}));
            if (typeof url === 'undefined') {
                document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
            } else {
                document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
            }
            resetLabels([layer_UPDATE_19_01_2026_2107_0]);
            map.on("zoomend", function(){
                resetLabels([layer_UPDATE_19_01_2026_2107_0]);
            });
            map.on("layeradd", function(){
                resetLabels([layer_UPDATE_19_01_2026_2107_0]);
            });
            map.on("layerremove", function(){
                resetLabels([layer_UPDATE_19_01_2026_2107_0]);
            });

            // --- FITUR PENCARIAN VIA URL ---
            // Mencari di layer 'layer_UPDATE_19_01_2026_2107_0'
            // Menggunakan parameter URL 'fid' untuk mencocokkan properti 'fid' di data
            if (typeof searchAndHighlightByUrl === 'function') {
                // searchAndHighlightByUrl(map, layer_UPDATE_19_01_2026_2107_0, 'fid', 'fid');
                searchAndHighlightByUrl(map, layer_UPDATE_19_01_2026_2107_0, 'fid', 'fid', {
                    marker: {
                        icon: false,
                        animate: true,
                        circle: {
                            radius: 10,
                            weight: 3,
                            color: "#e03",
                            stroke: true,
                            fill: false
                        }
                    }
                });
            }
        
        }); // End Window Load
        </script>        
    </body>
</html>