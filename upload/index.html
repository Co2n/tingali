<!DOCTYPE html>
<html lang="id">

<head>
   <meta charset="UTF-8">

   <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
   <meta http-equiv="Pragma" content="no-cache">
   <meta http-equiv="Expires" content="0">

   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Form Input Data Rekap</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
      body {
         background-color: #f8f9fa;
         padding-bottom: 50px;
      }

      .card {
         box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
         border: none;
         margin-bottom: 20px;
      }

      .card-header {
         background-color: #0d6efd;
         color: white;
         font-weight: bold;
      }

      .preview-container {
         margin-top: 10px;
         border: 2px dashed #ccc;
         min-height: 150px;
         display: flex;
         align-items: center;
         justify-content: center;
         position: relative;
         background: #fff;
         overflow: hidden;
      }

      canvas {
         max-width: 100%;
         height: auto;
      }

      .loading-overlay {
         display: none;
         position: absolute;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background: rgba(255, 255, 255, 0.8);
         z-index: 10;
         align-items: center;
         justify-content: center;
      }

      .required::after {
         content: " *";
         color: red;
      }

      /* Style untuk loading screen saat submit */
      #global-loading {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.7);
         z-index: 9999;
         color: white;
         flex-direction: column;
         align-items: center;
         justify-content: center;
      }
   </style>

   <script>
      document.write('<style>/* ' + new Date().getTime() + ' */</style>');
   </script>
</head>

<body>

   <div id="global-loading">
      <div class="spinner-border text-light mb-3" role="status"></div>
      <h3>Mengirim Data ke Server...</h3>
      <p>Mohon jangan tutup halaman ini.</p>
   </div>

   <div class="container mt-4">
      <h2 class="text-center mb-2">Form Input Data Tanah (Rekap)</h2>
      <h6 class="text-center mb-4 text-muted" id="fidDisplay">Memuat FID...</h4>
      <h4 class="text-center mb-4 text-muted" id="nibDisplay">Memuat NIB...</h4>

      <form id="rekapForm">

         <input type="hidden" name="fid" id="fidInput">

         <div class="card">
            <div class="card-header">1. Data Objek Pajak</div>
            <div class="card-body">
               <div class="row g-3">
                  <div class="col-md-4">
                     <!-- tambahkan label class required ke label jika wajib diisi dan tambahkan setelah id required -->
                     <label class="form-label">NOP</label>
                     <input type="text" class="form-control" name="nop" id="nopInput" placeholder="Contoh: 001-0025"
                        inputmode="numeric">
                     <small class="text-danger d-none" id="nopError">Tidak boleh mengandung titik!</small>
                  </div>
                  <div class="col-md-4">
                     <label class="form-label">Nama di SPPT</label>
                     <input type="text" class="form-control uppercase-input" name="nama" placeholder="NAMA">
                  </div>
                  <div class="col-md-4">
                     <label class="form-label">Luas di SPPT (m¬≤)</label>
                     <input type="number" class="form-control" name="luas">
                  </div>
                  <div class="col-12">
                     <label class="form-label">Foto SPPT</label>
                     <!-- tambahkan  capture="environment" untuk langsung ke kamera di mobile -->
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_sppt">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_sppt"></canvas>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div class="card">
            <div class="card-header">2. Data Pemilik</div>
            <div class="card-body">
               <div class="row g-3">
                  <div class="col-md-4">
                     <label class="form-label">Nama Pemilik</label>
                     <input type="text" class="form-control uppercase-input" name="pemilik"
                        placeholder="NAMA SESUAI KTP">
                  </div>
                  <div class="col-md-4">
                     <label class="form-label">Foto KTP</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_ktp">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_ktp"></canvas>
                     </div>
                  </div>
                  <div class="col-md-4">
                     <label class="form-label">Foto KK</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_kk">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_kk"></canvas>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div class="card">
            <div class="card-header">3. Bukti Kepemilikan</div>
            <div class="card-body">
               <div class="mb-3">
                  <label class="form-label">Nomor Bukti</label>
                  <input type="text" class="form-control" name="nobukti">
               </div>
               <div class="row g-3">
                  <div class="col-md-6">
                     <label class="form-label">Bukti Hal 1</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_b1">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_b1"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Bukti Hal 2</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_b2">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_b2"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Bukti Hal 3</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_b3">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_b3"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Bukti Hal 4</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_b4">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_b4"></canvas>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div class="card">
            <div class="card-header">4. Persetujuan</div>
            <div class="card-body">
               <div class="row g-3">
                  <div class="col-md-6">
                     <label class="form-label">Nama Persetujuan</label>
                     <input type="text" class="form-control uppercase-input" name="nm_persetujuan">
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Sebagai (SBG)</label>
                     <select class="form-select" name="sbg">
                        <option value="" selected disabled>Pilih Status...</option>
                        <option value="SUAMI">SUAMI</option>
                        <option value="ISTRI">ISTRI</option>
                        <option value="ANAK">ANAK</option>
                        <option value="SAUDARA">SAUDARA</option>
                     </select>
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Foto KTP Penyetuju</label>
                     <input type="file" class="form-control img-input" accept="image/*"
                        capture="environment" data-target="canvas_ktpagree">
                     <div class="preview-container">
                        <div class="loading-overlay">Proses...</div><canvas id="canvas_ktpagree"></canvas>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         
         <div class="card">
            <div class="card-header">5. Harga dan Referensi</div>
            <div class="card-body">
               <div class="row g-3">
                  <div class="col-md-6">
                     <label class="form-label">Harga Kesepakatan</label>
                     <input type="text" class="form-control" name="harga" id="hargaInput" placeholder="Rp. 0">
                  </div>
                  <div class="col-md-6">
                     <label class="form-label">Referensi (tulis nama singkat petugas perekap data)</label>
                     <input type="text" class="form-control uppercase-input" name="reff">
                  </div>
               </div>
            </div>
         </div>

         <div class="card border-danger">
            <div class="card-header bg-danger text-white">Konfirmasi Keamanan</div>
            <div class="card-body">
               <div class="mb-3">
                  <label class="form-label required">Masukkan Kode Akses (Password)</label>
                  <input type="password" class="form-control" id="securityPass"
                     placeholder="Masukkan password untuk menyimpan">
               </div>
            </div>
         </div>

         <div class="row g-2 mb-5">
            <div class="col-6">
               <button type="button" class="btn btn-outline-secondary btn-lg w-100" onclick="confirmExit()">
                  ‚ùå Keluar
               </button>
            </div>
            <div class="col-6">
               <button type="submit" class="btn btn-primary btn-lg w-100">
                  üíæ Simpan
               </button>
            </div>
         </div>

      </form>
   </div>

   <script>
      // --- GANTI URL INI DENGAN URL DEPLOY ANDA ---
      const GAS_URL = "https://script.google.com/macros/s/AKfycbwy5IXU5SY57x4XrLfe9f-4WO-zyGKf0wLnX-SUoiWE7zYN5AWIEAUquWavZIr3I91F/exec";

      // --- 0. URL PARAM & FETCH DATA LOGIC ---
      document.addEventListener("DOMContentLoaded", function () {
         const urlParams = new URLSearchParams(window.location.search);
         const fidValue = urlParams.get('fid');
         const nibValue = urlParams.get('nib');

         const fidInput = document.getElementById('fidInput');
         const fidDisplay = document.getElementById('fidDisplay');
         const nibDisplay = document.getElementById('nibDisplay');

         if (nibValue) {
            nibDisplay.innerText = "NIB: " + nibValue;
            nibDisplay.classList.remove("text-muted");
            nibDisplay.classList.add("text-success", "fw-bold");
         }

         if (fidValue) {
            fidInput.value = fidValue;
            fidDisplay.innerText = "FID: " + fidValue + " (Mengecek Data...)";
            fidDisplay.classList.remove("text-muted");
            fidDisplay.classList.add("text-primary");

            // Panggil Fungsi Fetch Data
            fetchData(fidValue);
         } else {
            fidDisplay.innerText = "PERINGATAN: Parameter FID tidak ditemukan di URL!";
            fidDisplay.classList.add("text-danger");
         }
      });

      // Fungsi Ambil Data dari Spreadsheet
      function fetchData(fid) {
         // Tampilkan loading screen
         document.getElementById('global-loading').style.display = 'flex';
         document.querySelector('#global-loading h3').innerText = "Cek datanya dulu ya...";

         fetch(GAS_URL + "?fid=" + fid) // Request GET ke GAS
            .then(response => response.json())
            .then(data => {
               document.getElementById('global-loading').style.display = 'none';
               document.querySelector('#global-loading h3').innerText = "Mengirim Data ke Server..."; // Reset text

               if (data.status === 'found') {
                  const d = data.data;
                  const display = document.getElementById('fidDisplay');
                  display.innerText = "FID: " + fid + " (MODE EDIT/UPDATE)";
                  display.classList.remove("text-primary");
                  display.classList.add("text-success", "fw-bold");

                  // Tampilkan NIB
                  const nibDisplay = document.getElementById('nibDisplay');
                  const urlParams = new URLSearchParams(window.location.search);
                  if (!urlParams.get('nib')) {
                     nibDisplay.innerText = "NIB: " + (d.nib || "-");
                  }

                  // --- ISI FORM OTOMATIS (Populate) ---
                  document.querySelector('[name="nop"]').value = d.nop;
                  document.querySelector('[name="nama"]').value = d.nama;
                  document.querySelector('[name="luas"]').value = d.luas;
                  document.querySelector('[name="pemilik"]').value = d.pemilik;
                  document.querySelector('[name="nobukti"]').value = d.nobukti;
                  document.querySelector('[name="nm_persetujuan"]').value = d.nm_persetujuan;
                  document.querySelector('[name="sbg"]').value = d.sbg;
                  document.querySelector('[name="reff"]').value = d.reff;
                  document.querySelector('[name="harga"]').value = d.harga ? formatRupiah(d.harga.toString(), 'Rp. ') : '';

                  // --- TAMPILKAN LINK FOTO LAMA (VERSI RESPONSIF) ---
                  const showOldImg = (url, canvasId) => {
                     if (url && url.length > 5) {
                        const canvas = document.getElementById(canvasId);
                        const previewContainer = canvas.parentElement; // Ini kotak garis putus-putus
                        const wrapper = previewContainer.parentElement; // Ini kolom (col-md-*)

                        // 1. Cek apakah pesan sudah ada (biar tidak duplikat saat klik tombol berkali-kali)
                        const existingMsg = wrapper.querySelector('.old-file-msg');
                        if (existingMsg) existingMsg.remove();

                        // 2. Buat elemen pesan dengan styling Bootstrap agar responsif
                        const info = document.createElement('div');
                        info.className = 'old-file-msg alert alert-success py-1 px-2 mb-2 mt-2';
                        info.style.fontSize = '0.8rem';
                        info.style.lineHeight = '1.2';

                        // 3. Isi HTML (Dibuat turun baris agar aman di HP)
                        info.innerHTML = `
                              <div class="d-flex justify-content-between align-items-center">
                                 <span>‚úÖ <b>Foto Tersimpan</b></span>
                                 <a href="${url}" target="_blank" class="btn btn-sm btn-outline-success py-0" style="font-size: 0.75rem;">Lihat Foto</a>
                              </div>
                              <div class="text-muted mt-1 border-top pt-1" style="font-size: 0.7rem;">
                                 <i>Upload foto baru jika ingin mengganti.</i>
                              </div>
                           `;

                        // 4. Masukkan pesan DI ATAS kotak preview (bukan di dalamnya)
                        wrapper.insertBefore(info, previewContainer);

                        // Opsional: Beri border hijau pada container preview tanda ada isinya
                        previewContainer.style.borderColor = '#198754';
                        previewContainer.style.backgroundColor = '#f8fff9';
                     }
                  };

                  showOldImg(d.sppt_url, 'canvas_sppt');
                  showOldImg(d.ktp_url, 'canvas_ktp');
                  showOldImg(d.kk_url, 'canvas_kk');
                  showOldImg(d.bukti1_url, 'canvas_b1');
                  showOldImg(d.bukti2_url, 'canvas_b2');
                  showOldImg(d.bukti3_url, 'canvas_b3');
                  showOldImg(d.bukti4_url, 'canvas_b4');
                  showOldImg(d.ktpagree_url, 'canvas_ktpagree');

                  alert("Alhamdulillah Data ditemukan! Silakan edit jika diperlukan.");

               } else {
                  document.getElementById('fidDisplay').innerText = "FID: " + fid + " (DATA BARU)";
               }
            })
            .catch(err => {
               document.getElementById('global-loading').style.display = 'none';
               console.error(err);
            });
      }

      // --- LOGIKA VALIDASI & OPENCV (TETAP SAMA) ---
      // 1. Validasi String
      document.querySelectorAll('.uppercase-input').forEach(input => {
         input.addEventListener('input', function () { this.value = this.value.toUpperCase(); });
      });

      // 2. Validasi NOP
      const nopInput = document.getElementById('nopInput');
      nopInput.addEventListener('input', function (e) {
         if (this.value.includes('.')) {
            document.getElementById('nopError').classList.remove('d-none');
            this.value = this.value.replace(/\./g, '');
         } else {
            document.getElementById('nopError').classList.add('d-none');
         }
      });

      // 4. Format Rupiah
      const hargaInput = document.getElementById('hargaInput');
      if (hargaInput) {
         hargaInput.addEventListener('keyup', function (e) {
            this.value = formatRupiah(this.value, 'Rp. ');
         });
      }

      function formatRupiah(angka, prefix) {
         var number_string = angka.replace(/[^,\d]/g, '').toString(),
            split = number_string.split(','),
            sisa = split[0].length % 3,
            rupiah = split[0].substr(0, sisa),
            ribuan = split[0].substr(sisa).match(/\d{3}/gi);

         if (ribuan) {
            separator = sisa ? '.' : '';
            rupiah += separator + ribuan.join('.');
         }

         rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
         return prefix == undefined ? rupiah : (rupiah ? 'Rp. ' + rupiah : '');
      }

      // Input File Handler
      document.querySelectorAll('.img-input').forEach(input => {
         input.addEventListener('change', function (e) {
            if (e.target.files.length === 0) return;

            // Hapus pesan "Foto tersimpan" jika user upload baru
            const wrapper = input.parentElement;
            const prevInfo = wrapper.querySelector('.old-file-msg');
            if (prevInfo) prevInfo.remove();

            const file = e.target.files[0];
            const canvasId = e.target.dataset.target;
            const canvas = document.getElementById(canvasId);
            const overlay = wrapper.querySelector('.loading-overlay');

            overlay.style.display = 'flex';
            const img = new Image();
            img.onload = function () {
               const ctx = canvas.getContext('2d');
               // Resize agar tidak terlalu besar (max width 800px)
               const maxWidth = 800;
               let newWidth = img.width;
               let newHeight = img.height;

               if (img.width > maxWidth) {
                  newWidth = maxWidth;
                  newHeight = img.height * (maxWidth / img.width);
               }

               canvas.width = newWidth;
               canvas.height = newHeight;
               ctx.drawImage(img, 0, 0, newWidth, newHeight);
               
               overlay.style.display = 'none';
            };
            img.src = URL.createObjectURL(file);
         });
      });

      // --- PENGIRIMAN DATA (SUBMIT) ---
      document.getElementById('rekapForm').addEventListener('submit', function (e) {
         e.preventDefault();

         if (GAS_URL.includes("URL_GOOGLE_APPS_SCRIPT")) {
            alert("ERROR: URL Script belum disetting!"); return;
         }

         const password = document.getElementById('securityPass').value;
         if (!password) { alert("Masukkan password!"); return; }

         document.getElementById('global-loading').style.display = 'flex';

         const formData = new FormData(this);
         let dataObj = {};
         formData.forEach((value, key) => { dataObj[key] = value; });

         // FIX: Hapus format Rupiah (Rp. dan titik) agar yang terkirim ke server hanya angka murni
         if (dataObj.harga) {
            dataObj.harga = dataObj.harga.replace(/[^0-9]/g, '');
         }

         dataObj.password = password;

         // Helper Canvas
         const getCanvasImage = (id) => {
            const canvas = document.getElementById(id);
            // Hanya kirim data gambar jika canvas memiliki konten yang valid (user upload baru)
            // Cek sederhana: jika user tidak upload file, input file value kosong.
            // Namun canvas logic kita hanya jalan 'onload' file.
            // Jadi: Cek apakah input file terkait ada filenya
            const fileInput = document.querySelector(`input[data-target="${id}"]`);
            if (fileInput && fileInput.files.length > 0) {
               // Kompresi agar di bawah 100KB
               let quality = 0.7;
               let dataUrl = canvas.toDataURL('image/jpeg', quality);
               const maxBytes = 100 * 1024; // 100KB

               while (dataUrl.length * 0.75 > maxBytes && quality > 0.1) {
                  quality -= 0.1;
                  dataUrl = canvas.toDataURL('image/jpeg', quality);
               }
               return dataUrl;
            }
            return ""; // Kirim string kosong agar backend mempertahankan foto lama
         };

         dataObj.sppt = getCanvasImage('canvas_sppt');
         dataObj.ktp = getCanvasImage('canvas_ktp');
         dataObj.kk = getCanvasImage('canvas_kk');
         dataObj.bukti_hal_1 = getCanvasImage('canvas_b1');
         dataObj.bukti_hal_2 = getCanvasImage('canvas_b2');
         dataObj.bukti_hal_3 = getCanvasImage('canvas_b3');
         dataObj.bukti_hal_4 = getCanvasImage('canvas_b4');
         dataObj.ktpagree = getCanvasImage('canvas_ktpagree');

         fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(dataObj)
         })
            .then(response => response.json())
            .then(data => {
               document.getElementById('global-loading').style.display = 'none';

               if (data.status === 'success') {
                  // 1. Tampilkan pesan sukses
                  // User harus klik OK dulu, baru kode di bawahnya jalan
                  alert("SUKSES: " + data.message + "\n\nTab ini akan ditutup otomatis.");

                  // 2. Tutup Tab Otomatis
                  try {
                     window.close();
                  } catch (e) {
                     console.log("Gagal menutup window otomatis", e);
                  }

                  // 3. Fallback: Jika browser memblokir window.close() (jarang terjadi di target="_blank")
                  // Kita ganti tampilan body agar user tahu proses selesai
                  document.body.innerHTML = `
                    <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; font-family:sans-serif;">
                        <h1 style="color:green;">‚úÖ Data Berhasil Disimpan!</h1>
                        <p>Anda wajib menutup tab ini setelah proses selesai.</p>
                        <button onclick="window.close()" style="padding:10px 20px; font-size:16px; cursor:pointer;">Tutup Tab</button>
                    </div>
                `;

               } else {
                  // Jika error dari server (misal password salah)
                  alert("GAGAL: " + data.message);
               }
            })
            .catch(error => {
               document.getElementById('global-loading').style.display = 'none';
               alert("ERROR JARINGAN: " + error);
            });
      });
      // --- FUNGSI KELUAR TAB ---
      function confirmExit() {
         // Tanya dulu biar data tidak hilang tidak sengaja
         if (confirm("Apakah Anda yakin ingin keluar? Perubahan data TIDAK akan disimpan.")) {
            window.close();

            // Fallback jika window.close() diblokir browser
            document.body.innerHTML = "<div class='text-center mt-5'><h3>Tab telah ditutup.</h3><p>Anda bisa menutup halaman ini secara manual.</p></div>";
         }
      }
   </script>

</body>

</html>